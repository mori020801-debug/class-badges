<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>名札表示</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#fff;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;}
    .wrap{height:100%; display:flex; align-items:center; justify-content:center; text-align:center; padding:1rem; box-sizing:border-box;}
    .card{width:100%; max-width:1200px;}
    .name{
      font-weight:800;
      font-size: calc(8vw + 20px);
      line-height:0.95;
      word-break:break-word;
      letter-spacing:0.02em;
    }
    .sub{font-size:calc(2.5vw + 8px); opacity:0.95; margin-top:0.5rem;}
    .controls{position:fixed; left:10px; top:10px; display:flex; gap:8px; z-index:30;}
    .controls button{padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.12); color:inherit; backdrop-filter:blur(6px);}
    .hint{position:fixed; bottom:8px; width:100%; text-align:center; font-size:14px;}
    .overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); color:#fff; z-index:40; padding:1rem; text-align:center;}
    .hidden{display:none;}
    input.name-input{font-size:18px; padding:10px; width:80%; max-width:400px; border-radius:8px; border:0; outline:none;}
    .btn{margin-left:8px; padding:10px 14px; border-radius:8px; border:0;}
    @media (orientation:portrait){
      .name{font-size: calc(10vw + 16px);}
    }
  </style>
</head>
<body>
  <div class="controls" aria-hidden="true">
    <button id="bgDark">黒</button>
    <button id="bgLight">白</button>
    <button id="bgYellow">黄</button>
  </div>

  <div class="wrap" role="main">
    <div class="card">
      <div id="nameEl" class="name">読み込み中…</div>
      <div id="subEl" class="sub">画面を横向き（ランドスケープ）にして見やすくしてください</div>
    </div>
  </div>

  <div id="rotateOverlay" class="overlay hidden">
    <div>
      <div style="font-size:22px; font-weight:700; margin-bottom:8px;">画面を横向きにしてください</div>
      <div style="opacity:0.95">横向きの方が見やすくなります</div>
    </div>
  </div>

  <div id="inputOverlay" class="overlay hidden">
    <div>
      <div style="font-size:20px; font-weight:700; margin-bottom:10px;">表示する名前を入力してください</div>
      <div><input id="nameInput" class="name-input" placeholder="例：山田 太郎"></div>
      <div style="margin-top:10px;"><button id="saveBtn" class="btn">保存して表示</button></div>
      <div style="margin-top:12px; font-size:13px; opacity:0.9">※ホーム画面に追加すると次回から簡単に開けます</div>
    </div>
  </div>

  <div class="hint">ホーム画面に追加すると次回からワンタップで開けます（iPhone：Safariの共有→「ホーム画面に追加」、Android：Chromeメニュー→「ホーム画面に追加」）。</div>

<script>
  const nameEl = document.getElementById('nameEl');
  const subEl = document.getElementById('subEl');
  const rotateOverlay = document.getElementById('rotateOverlay');
  const inputOverlay = document.getElementById('inputOverlay');
  const nameInput = document.getElementById('nameInput');
  const saveBtn = document.getElementById('saveBtn');

  function getParam(k){ return new URLSearchParams(location.search).get(k); }
  function showRotateIfNeeded(){
    if(window.innerWidth < window.innerHeight){
      rotateOverlay.classList.remove('hidden');
    } else rotateOverlay.classList.add('hidden');
  }
  window.addEventListener('resize', showRotateIfNeeded);
  showRotateIfNeeded();

  // 背景切替
  document.getElementById('bgDark').onclick = ()=>{ document.body.style.background='#0b1220'; document.body.style.color='#fff'; }
  document.getElementById('bgLight').onclick = ()=>{ document.body.style.background='#ffffff'; document.body.style.color='#000'; }
  document.getElementById('bgYellow').onclick = ()=>{ document.body.style.background='#ffec3d'; document.body.style.color='#000'; }

  // 名前取得ロジック：URL param > localStorage > prompt
  const paramName = getParam('name');
  const storageKey = 'class_badge_name_v1';
  function setName(n){
    if(!n) n = '（名前が未設定）';
    nameEl.textContent = n;
    document.title = n + ' — 名札';
  }

  if(paramName){
    const decoded = decodeURIComponent(paramName);
    setName(decoded);
    try{ localStorage.setItem(storageKey, decoded); }catch(e){}
  } else {
    try{
      const stored = localStorage.getItem(storageKey);
      if(stored){
        setName(stored);
      } else {
        // 表示入力フォームを出す（フルスクリーンモーダル）
        inputOverlay.classList.remove('hidden');
        saveBtn.onclick = ()=>{
          const v = nameInput.value.trim();
          if(v){
            setName(v);
            inputOverlay.classList.add('hidden');
            try{ localStorage.setItem(storageKey, v); }catch(e){}
          } else {
            alert('名前を入力してください');
          }
        };
      }
    } catch(e){
      // localStorage使えない場合は prompt
      const p = prompt('表示する名前を入力してください（例：山田 太郎）');
      setName(p);
    }
  }

  // 長い名前の調整（縮小）
  function adjustFont(){
    const el = nameEl;
    el.style.fontSize = ''; // reset
    let fs = parseFloat(getComputedStyle(el).fontSize);
    const maxWidth = window.innerWidth * 0.9;
    while(el.scrollWidth > maxWidth && fs > 12){
      fs = fs * 0.95;
      el.style.fontSize = fs + 'px';
    }
  }
  window.addEventListener('resize', adjustFont);
  setTimeout(adjustFont,200);
</script>
</body>
</html>
